<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>em-odp: timer_hello.c</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doc-stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">em-odp
   &#160;<span id="projectnumber">2.5.0</span>
   </div>
   <div id="projectbrief">Event Machine on ODP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d5/dfe/timer_hello_8c-example.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">timer_hello.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> *   Copyright (c) 2016, Nokia Solutions and Networks</span></div><div class="line"><span class="comment"> *   All rights reserved.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   Redistribution and use in source and binary forms, with or without</span></div><div class="line"><span class="comment"> *   modification, are permitted provided that the following conditions</span></div><div class="line"><span class="comment"> *   are met:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *     * Redistributions of source code must retain the above copyright</span></div><div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer.</span></div><div class="line"><span class="comment"> *     * Redistributions in binary form must reproduce the above copyright</span></div><div class="line"><span class="comment"> *       notice, this list of conditions and the following disclaimer in the</span></div><div class="line"><span class="comment"> *       documentation and/or other materials provided with the distribution.</span></div><div class="line"><span class="comment"> *     * Neither the name of the copyright holder nor the names of its</span></div><div class="line"><span class="comment"> *       contributors may be used to endorse or promote products derived</span></div><div class="line"><span class="comment"> *       from this software without specific prior written permission.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div><div class="line"><span class="comment"> *   &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div><div class="line"><span class="comment"> *   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></div><div class="line"><span class="comment"> *   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></div><div class="line"><span class="comment"> *   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></div><div class="line"><span class="comment"> *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></div><div class="line"><span class="comment"> *   LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></div><div class="line"><span class="comment"> *   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></div><div class="line"><span class="comment"> *   THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></div><div class="line"><span class="comment"> *   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div><div class="line"><span class="comment"> *   OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Event Machine timer add-on hello world example.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Timer hello world example to show basic event timer usage. Creates a</span></div><div class="line"><span class="comment"> * single EO that starts a periodic and a random one-shot timeout.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Exception/error management is simplified to focus on basic timer usage.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#ifndef _GNU_SOURCE</span></div><div class="line"><span class="preprocessor">#define _GNU_SOURCE</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../d7/d5e/event__machine_8h.html">event_machine.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../db/d46/event__machine__timer_8h.html">event_machine/add-ons/event_machine_timer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="../../de/d26/environment_8h.html">event_machine/platform/env/environment.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;cm_setup.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;cm_error_handler.h&quot;</span></div><div class="line"></div><div class="line"><span class="comment">/* test app defines */</span></div><div class="line"><span class="preprocessor">#define APP_MAX_TEXT_LEN    128 </span><span class="comment">/* string length limit */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define APP_TIMEOUT_MODULO_MS   30000   </span><span class="comment">/* max random timeout */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define APP_TIMEOUT_MIN_MS  100 </span><span class="comment">/* minimum random timeout */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define APP_PERIOD_MS       1000    </span><span class="comment">/* heartbeat tick period */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="preprocessor">#define APP_EO_NAME &quot;Control EO&quot;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Example application message event</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> app_cmd_t {</div><div class="line">    APP_CMD_TMO,        <span class="comment">/* periodic timeout */</span></div><div class="line">    APP_CMD_HELLO       <span class="comment">/* random timeout */</span></div><div class="line">} app_cmd_t;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>app_msg_t {</div><div class="line">    app_cmd_t command;</div><div class="line">    uint64_t count;</div><div class="line">    <span class="keywordtype">char</span> text[APP_MAX_TEXT_LEN];</div><div class="line">    <span class="comment">/* for managing periodic timeouts */</span></div><div class="line">    <a name="_a0"></a><a class="code" href="../../dd/d32/structem__timer__timeout__t.html">em_tmo_t</a> tmo;</div><div class="line">} app_msg_t;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * EO context</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>app_eo_ctx_t {</div><div class="line">    <a class="code" href="../../dd/d32/structem__timer__timeout__t.html">em_tmo_t</a> periodic_tmo;</div><div class="line">    <a class="code" href="../../dd/d32/structem__timer__timeout__t.html">em_tmo_t</a> random_tmo;</div><div class="line">    em_queue_t my_q;</div><div class="line">    uint64_t hz;</div><div class="line">} app_eo_ctx_t;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Timer hello world shared memory data</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>timer_app_shm_t {</div><div class="line">    <span class="comment">/* Event pool used by this application */</span></div><div class="line">    em_pool_t pool;</div><div class="line">    <span class="comment">/* EO context data */</span></div><div class="line">    app_eo_ctx_t eo_context;</div><div class="line">    em_queue_t eo_q;</div><div class="line">    em_timer_t tmr;</div><div class="line">    <span class="comment">/* Pad size to a multiple of cache line size */</span></div><div class="line">    <span class="keywordtype">void</span> *end[0] <a name="a1"></a><a class="code" href="../../de/d26/environment_8h.html#a13093fb72d4f1f0be2f85cf449f4d543">ENV_CACHE_LINE_ALIGNED</a>;</div><div class="line">} timer_app_shm_t;</div><div class="line"></div><div class="line"><span class="comment">/* EM-core locals */</span></div><div class="line"><span class="keyword">static</span> <a name="a2"></a><a class="code" href="../../de/d26/environment_8h.html#a2b2462b2491461a5c14adb1eb4493a8c">ENV_LOCAL</a> timer_app_shm_t *m_shm;</div><div class="line"><span class="keyword">static</span> <a class="code" href="../../de/d26/environment_8h.html#a2b2462b2491461a5c14adb1eb4493a8c">ENV_LOCAL</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m_randseed;</div><div class="line"></div><div class="line"><span class="comment">/* Local function prototypes */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> app_eo_start(app_eo_ctx_t *eo_ctx, em_eo_t eo,</div><div class="line">                <span class="keyword">const</span> <a name="_a3"></a><a class="code" href="../../de/dc0/structem__eo__conf__t.html">em_eo_conf_t</a> *conf);</div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> app_eo_start_local(app_eo_ctx_t *eo_ctx, em_eo_t eo);</div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> app_eo_stop(app_eo_ctx_t *eo_ctx, em_eo_t eo);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_eo_receive(app_eo_ctx_t *eo_ctx, em_event_t event,</div><div class="line">               <a class="code" href="../../d4/d11/event__machine__types_8h.html#a49fd700da185b0f64834bf967479a992">em_event_type_t</a> type, em_queue_t queue,</div><div class="line">               <span class="keywordtype">void</span> *q_ctx);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> new_rand_timeout(app_eo_ctx_t *eo_ctx);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Main function</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Call cm_setup() to perform test &amp; EM setup common for all the</span></div><div class="line"><span class="comment"> * test applications.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * cm_setup() will call test_init() and test_start() and launch</span></div><div class="line"><span class="comment"> * the EM dispatch loop on every EM-core.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> cm_setup(argc, argv);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Before EM - Init of the test application.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * The shared memory is needed if EM instance runs on multiple processes.</span></div><div class="line"><span class="comment"> * Doing it like this makes it possible to run the app both as threads (-t)</span></div><div class="line"><span class="comment"> * as well as processes (-p).</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @attention Run on all cores.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @see cm_setup() for setup and dispatch.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> test_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> core = <a name="a4"></a><a class="code" href="../../d5/d69/group__em__core.html#ga13d21af31382ec2c3d45010645707e9c">em_core_id</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (core == 0) {</div><div class="line">        <span class="comment">/* first core creates the ShMem */</span></div><div class="line">        m_shm = env_shared_reserve(<span class="stringliteral">&quot;TimerAppShMem&quot;</span>,</div><div class="line">                       <span class="keyword">sizeof</span>(timer_app_shm_t));</div><div class="line">        <a name="a5"></a><a class="code" href="../../db/da0/group__em__error.html#gaf7332965c5deaa69411136e8d36089c6">em_register_error_handler</a>(test_error_handler);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        m_shm = env_shared_lookup(<span class="stringliteral">&quot;TimerAppShMem&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (m_shm == NULL) {</div><div class="line">        test_error(<a name="a6"></a><a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ac341b7db29d8127e864a45c9bd2a4aa3">EM_ERROR_SET_FATAL</a>(0xDEAD), 0xBEEF,</div><div class="line">               <span class="stringliteral">&quot;init failed on EM-core: %u&quot;</span>,</div><div class="line">               <a class="code" href="../../d5/d69/group__em__core.html#ga13d21af31382ec2c3d45010645707e9c">em_core_id</a>());</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (core == 0) {</div><div class="line">        <span class="comment">/* initialize shared memory for EM app init */</span></div><div class="line">        memset(m_shm, 0, <span class="keyword">sizeof</span>(timer_app_shm_t));</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Startup of the timer hello EM application.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * At this point EM is up, but no EOs exist. EM API can be used to create</span></div><div class="line"><span class="comment"> * queues, EOs etc.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @attention Run only on EM core 0.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param appl_conf Application configuration</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @see cm_setup() for setup and dispatch.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">void</span> test_start(appl_conf_t *<span class="keyword">const</span> appl_conf)</div><div class="line">{</div><div class="line">    em_eo_t eo;</div><div class="line">    <a name="_a7"></a><a class="code" href="../../d4/d00/structem__timer__attr__t.html">em_timer_attr_t</a> attr;</div><div class="line">    em_queue_t queue;</div><div class="line">    <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> stat;</div><div class="line">    em_event_t event;</div><div class="line">    app_msg_t *msg;</div><div class="line">    app_eo_ctx_t *eo_ctx;</div><div class="line">    uint64_t period;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Store the event pool to use, use the EM default pool if no other</span></div><div class="line"><span class="comment">     * pool is provided through the appl_conf.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> (appl_conf-&gt;num_pools &gt;= 1)</div><div class="line">        m_shm-&gt;pool = appl_conf-&gt;pools[0];</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        m_shm-&gt;pool = <a name="a8"></a><a class="code" href="../../db/d6d/event__machine__hw__config_8h.html#aaa0a290a45f4b1280f3330fadde6bfde">EM_POOL_DEFAULT</a>;</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;\n&quot;</span></div><div class="line">           <span class="stringliteral">&quot;***********************************************************\n&quot;</span></div><div class="line">           <span class="stringliteral">&quot;EM APPLICATION: &#39;%s&#39; initializing:\n&quot;</span></div><div class="line">           <span class="stringliteral">&quot;  %s: %s() - EM-core:%i\n&quot;</span></div><div class="line">           <span class="stringliteral">&quot;  Application running on %d EM-cores (procs:%d, threads:%d)\n&quot;</span></div><div class="line">           <span class="stringliteral">&quot;  using event pool:%&quot;</span> <a name="a9"></a><a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#a5f1ebfb654b7ec3169e068aa3776ff79">PRI_POOL</a> <span class="stringliteral">&quot;\n&quot;</span></div><div class="line">           <span class="stringliteral">&quot;***********************************************************\n&quot;</span></div><div class="line">           <span class="stringliteral">&quot;\n&quot;</span>,</div><div class="line">           appl_conf-&gt;name, NO_PATH(__FILE__), __func__, <a class="code" href="../../d5/d69/group__em__core.html#ga13d21af31382ec2c3d45010645707e9c">em_core_id</a>(),</div><div class="line">           <a name="a10"></a><a class="code" href="../../d5/d69/group__em__core.html#ga84fa6ec801b82a586ff5e31693d3deb8">em_core_count</a>(),</div><div class="line">           appl_conf-&gt;num_procs, appl_conf-&gt;num_threads,</div><div class="line">           m_shm-&gt;pool);</div><div class="line"></div><div class="line">    test_fatal_if(m_shm-&gt;pool == <a name="a11"></a><a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#a67fed61187c93569c92da0647970a29f">EM_POOL_UNDEF</a>,</div><div class="line">              <span class="stringliteral">&quot;Undefined application event pool!&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Create EO */</span></div><div class="line">    eo = <a name="a12"></a><a class="code" href="../../d8/d5f/group__em__eo.html#ga196c7caa1177575fd424e9a0d2854da6">em_eo_create</a>(APP_EO_NAME,</div><div class="line">              (<a name="a13"></a><a class="code" href="../../d8/d5f/group__em__eo.html#gad339451d68d77127ac2b7ba806f95c03">em_start_func_t</a>)app_eo_start,</div><div class="line">              (<a name="a14"></a><a class="code" href="../../d8/d5f/group__em__eo.html#ga600ad2f5ecb7fbfe26267071b3a86eb9">em_start_local_func_t</a>)app_eo_start_local,</div><div class="line">              (<a name="a15"></a><a class="code" href="../../d8/d5f/group__em__eo.html#ga71defe535ba0c4e16bf2cddfd4a4f8db">em_stop_func_t</a>)app_eo_stop, NULL,</div><div class="line">              (<a name="a16"></a><a class="code" href="../../d8/d5f/group__em__eo.html#ga63161b6f46fb08a1708bad6c1fde2622">em_receive_func_t</a>)app_eo_receive,</div><div class="line">              &amp;m_shm-&gt;eo_context);</div><div class="line">    test_fatal_if(eo == <a name="a17"></a><a class="code" href="../../d4/d11/event__machine__types_8h.html#af28fb8daf62b942ced417e158ed7e1c7">EM_EO_UNDEF</a>, <span class="stringliteral">&quot;Failed to create EO!&quot;</span>);</div><div class="line">    eo_ctx = &amp;m_shm-&gt;eo_context;</div><div class="line"></div><div class="line">    <span class="comment">/* one basic queue */</span></div><div class="line">    queue = <a name="a18"></a><a class="code" href="../../de/d3c/group__em__queue.html#gaef257858d1fa660524f198dba20fa9eb">em_queue_create</a>(<span class="stringliteral">&quot;Timer hello Q&quot;</span>,</div><div class="line">                <a name="a19"></a><a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#a368b59e8c18f57c4034420e3ba44e965aa3f46c70193d0a7d9bb8fc149a3179ea">EM_QUEUE_TYPE_PARALLEL</a>,</div><div class="line">                <a name="a20"></a><a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#a8171ccd1b7a0df99a6c7d0f3ec82e52fa2311aaab5842cd6b78e4587be0fbf0ca">EM_QUEUE_PRIO_NORMAL</a>,</div><div class="line">                <a name="a21"></a><a class="code" href="../../db/d6d/event__machine__hw__config_8h.html#ae56af1c575498ec19f0836ee916d0eb9">EM_QUEUE_GROUP_DEFAULT</a>, NULL);</div><div class="line">    stat = <a name="a22"></a><a class="code" href="../../d8/d5f/group__em__eo.html#gac9b818edd466228b6fb653bd9337da3e">em_eo_add_queue_sync</a>(eo, queue);</div><div class="line">    test_fatal_if(stat != <a name="a23"></a><a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>, <span class="stringliteral">&quot;Failed to create queue!&quot;</span>);</div><div class="line">    m_shm-&gt;eo_q = queue;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Create shared timer and store handle in shared memory.</span></div><div class="line"><span class="comment">     * Accept all defaults.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <a name="a24"></a><a class="code" href="../../de/dc2/group__em__timer.html#gad6023dd3c79d0a45221d9245c604c2e3">em_timer_attr_init</a>(&amp;attr);</div><div class="line">    strncpy(attr.<a name="a25"></a><a class="code" href="../../d4/d00/structem__timer__attr__t.html#a03fc2b0569742931ed610f0bd1af43ad">name</a>, <span class="stringliteral">&quot;ExampleTimer&quot;</span>, EM_TIMER_NAME_LEN);</div><div class="line">    m_shm-&gt;tmr = <a name="a26"></a><a class="code" href="../../de/dc2/group__em__timer.html#ga56968bda0ecacf996d6ce623e3e372ab">em_timer_create</a>(&amp;attr);</div><div class="line">    test_fatal_if(m_shm-&gt;tmr == <a name="a27"></a><a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#aa373a94a9084c3bd6c5b23ac6bd6b176">EM_TIMER_UNDEF</a>, <span class="stringliteral">&quot;Failed to create timer!&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Start EO */</span></div><div class="line">    stat = <a name="a28"></a><a class="code" href="../../d8/d5f/group__em__eo.html#gabe4f7a789ec9523367c086793061562d">em_eo_start_sync</a>(eo, NULL, NULL);</div><div class="line">    test_fatal_if(stat != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>, <span class="stringliteral">&quot;Failed to start EO!&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* create periodic timer */</span></div><div class="line">    eo_ctx-&gt;periodic_tmo = <a name="a29"></a><a class="code" href="../../de/dc2/group__em__timer.html#ga4fc3dd338b784ce9b122eeb3fbf4ea07">em_tmo_create</a>(m_shm-&gt;tmr, <a name="a30"></a><a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#gaade0f99e694a2f999abe467bc05fde61aac8e81389e6feaf233eff357c4ece5f0">EM_TMO_FLAG_PERIODIC</a>,</div><div class="line">                         eo_ctx-&gt;my_q);</div><div class="line">    test_fatal_if(eo_ctx-&gt;periodic_tmo == <a name="a31"></a><a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#af7917fb5bc546e1339ad6e1135fd8c6d">EM_TMO_UNDEF</a>, <span class="stringliteral">&quot;Can&#39;t allocate tmo!\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* allocate timeout event */</span></div><div class="line">    <span class="keyword">event</span> = <a name="a32"></a><a class="code" href="../../d5/d33/group__em__event.html#ga15a17cee0e5de5062e78f7db2b836761">em_alloc</a>(<span class="keyword">sizeof</span>(app_msg_t), <a name="a33"></a><a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ace0fe27049350469ff1be8188acfea89a2066feedf79f96d10ce9215fa5f37db1">EM_EVENT_TYPE_SW</a>, m_shm-&gt;pool);</div><div class="line">    test_fatal_if(event == <a name="a34"></a><a class="code" href="../../d4/d11/event__machine__types_8h.html#a8542d9c2c9a29e35ff042b1d59cc479b">EM_EVENT_UNDEF</a>, <span class="stringliteral">&quot;Can&#39;t allocate event!\n&quot;</span>);</div><div class="line"></div><div class="line">    msg = <a name="a35"></a><a class="code" href="../../d5/d33/group__em__event.html#ga8f701c3a5901fc81d922b9d1d02691e3">em_event_pointer</a>(event);</div><div class="line">    msg-&gt;command = APP_CMD_TMO;</div><div class="line">    msg-&gt;tmo = eo_ctx-&gt;periodic_tmo;</div><div class="line">    msg-&gt;count = 0;</div><div class="line">    eo_ctx-&gt;hz = <a name="a36"></a><a class="code" href="../../de/dc2/group__em__timer.html#gae97b08e2b1468de76a7d92342a5860ed">em_timer_get_freq</a>(m_shm-&gt;tmr); <span class="comment">/* save for later */</span></div><div class="line">    <span class="keywordflow">if</span> (eo_ctx-&gt;hz &lt; 1000) { <span class="comment">/* sanity check */</span></div><div class="line">        APPL_ERROR(<span class="stringliteral">&quot;WARNING - timer hz very low!\n&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* pre-allocate random timeout */</span></div><div class="line">    eo_ctx-&gt;random_tmo = <a class="code" href="../../de/dc2/group__em__timer.html#ga4fc3dd338b784ce9b122eeb3fbf4ea07">em_tmo_create</a>(m_shm-&gt;tmr, <a name="a37"></a><a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#gaade0f99e694a2f999abe467bc05fde61a8e5343b756922a7d6527d8ddff10ff14">EM_TMO_FLAG_ONESHOT</a>,</div><div class="line">                       eo_ctx-&gt;my_q);</div><div class="line">    test_fatal_if(eo_ctx-&gt;random_tmo == <a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#af7917fb5bc546e1339ad6e1135fd8c6d">EM_TMO_UNDEF</a>, <span class="stringliteral">&quot;Can&#39;t allocate tmo!\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* setup periodic timeout (the tick) */</span></div><div class="line">    period = eo_ctx-&gt;hz / 1000; <span class="comment">/* ticks for 1 ms */</span></div><div class="line">    period *= APP_PERIOD_MS;</div><div class="line">    stat = <a name="a38"></a><a class="code" href="../../de/dc2/group__em__timer.html#gabe6b4e51cd71d86d0e60534ba00cbac2">em_tmo_set_rel</a>(eo_ctx-&gt;periodic_tmo, period, event);</div><div class="line">    test_fatal_if(stat != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>, <span class="stringliteral">&quot;Can&#39;t activate tmo!\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">test_stop(appl_conf_t *<span class="keyword">const</span> appl_conf)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> core = <a class="code" href="../../d5/d69/group__em__core.html#ga13d21af31382ec2c3d45010645707e9c">em_core_id</a>();</div><div class="line">    <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> ret;</div><div class="line">    em_eo_t eo;</div><div class="line"></div><div class="line">    (void)appl_conf;</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;%s() on EM-core %d\n&quot;</span>, __func__, core);</div><div class="line"></div><div class="line">    eo = <a name="a39"></a><a class="code" href="../../d8/d5f/group__em__eo.html#ga9ac21d82f671fff3e31e83410e72d406">em_eo_find</a>(APP_EO_NAME);</div><div class="line">    test_fatal_if(eo == <a class="code" href="../../d4/d11/event__machine__types_8h.html#af28fb8daf62b942ced417e158ed7e1c7">EM_EO_UNDEF</a>, <span class="stringliteral">&quot;Could not find EO:%s&quot;</span>, APP_EO_NAME);</div><div class="line"></div><div class="line">    ret = <a name="a40"></a><a class="code" href="../../d8/d5f/group__em__eo.html#gadce026621953114bd26e5836d9693465">em_eo_stop_sync</a>(eo);</div><div class="line">    test_fatal_if(ret != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>,</div><div class="line">              <span class="stringliteral">&quot;EO:%&quot;</span> <a name="a41"></a><a class="code" href="../../d4/d11/event__machine__types_8h.html#a0bf4a25d46e18ee918e684e5deb27fa4">PRI_EO</a> <span class="stringliteral">&quot; stop:%&quot;</span> PRI_STAT <span class="stringliteral">&quot;&quot;</span>, eo, ret);</div><div class="line">    ret = <a name="a42"></a><a class="code" href="../../d8/d5f/group__em__eo.html#gae769b19e613b24487beb943cfb926977">em_eo_delete</a>(eo);</div><div class="line">    test_fatal_if(ret != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>,</div><div class="line">              <span class="stringliteral">&quot;EO:%&quot;</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#a0bf4a25d46e18ee918e684e5deb27fa4">PRI_EO</a> <span class="stringliteral">&quot; delete:%&quot;</span> PRI_STAT <span class="stringliteral">&quot;&quot;</span>, eo, ret);</div><div class="line"></div><div class="line">    ret = <a name="a43"></a><a class="code" href="../../de/dc2/group__em__timer.html#ga2bac1530b021bbbd1f0f924414c2485e">em_timer_delete</a>(m_shm-&gt;tmr);</div><div class="line">    test_fatal_if(ret != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>,</div><div class="line">              <span class="stringliteral">&quot;Timer:%&quot;</span> <a name="a44"></a><a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#a31cd14adb32c94ed0f2e27d263ad6eb1">PRI_TMR</a> <span class="stringliteral">&quot; delete:%&quot;</span> PRI_STAT <span class="stringliteral">&quot;&quot;</span>,</div><div class="line">              m_shm-&gt;tmr, ret);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">test_term(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> core = <a class="code" href="../../d5/d69/group__em__core.html#ga13d21af31382ec2c3d45010645707e9c">em_core_id</a>();</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;%s() on EM-core %d\n&quot;</span>, __func__, core);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (m_shm != NULL) {</div><div class="line">        env_shared_free(m_shm);</div><div class="line">        m_shm = NULL;</div><div class="line">        <a name="a45"></a><a class="code" href="../../db/da0/group__em__error.html#gab6b469100e5f60670a742d944a6f530b">em_unregister_error_handler</a>();</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @private</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * EO start function.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> app_eo_start(app_eo_ctx_t *eo_ctx, em_eo_t eo,</div><div class="line">                <span class="keyword">const</span> <a class="code" href="../../de/dc0/structem__eo__conf__t.html">em_eo_conf_t</a> *conf)</div><div class="line">{</div><div class="line">    <a class="code" href="../../d4/d00/structem__timer__attr__t.html">em_timer_attr_t</a> attr;</div><div class="line">    em_timer_t tmr;</div><div class="line">    <span class="keywordtype">int</span> num_timers;</div><div class="line"></div><div class="line">    (void)eo;</div><div class="line">    (void)conf;</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;EO start\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* print timer info */</span></div><div class="line">    num_timers = <a name="a46"></a><a class="code" href="../../de/dc2/group__em__timer.html#ga25b88dbbb772090d6caa5622c7017889">em_timer_get_all</a>(&amp;tmr, 1);</div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;System has %d timer(s)\n&quot;</span>, num_timers);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a name="a47"></a><a class="code" href="../../de/dc2/group__em__timer.html#ga01e680281f0ae40bce6c6786fc0bcdc3">em_timer_get_attr</a>(m_shm-&gt;tmr, &amp;attr) != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>) {</div><div class="line">        APPL_ERROR(<span class="stringliteral">&quot;Can&#39;t get timer info!\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> <a name="a48"></a><a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#a740919266fbb41b8a8127a9ef215eea0a5d88fb8b70a4b3edf790b3d650e7213e">EM_ERR_BAD_ID</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;Timer \&quot;%s\&quot; info:\n&quot;</span>, attr.<a class="code" href="../../d4/d00/structem__timer__attr__t.html#a03fc2b0569742931ed610f0bd1af43ad">name</a>);</div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;  -resolution: %&quot;</span> PRIu64 <span class="stringliteral">&quot; ns\n&quot;</span>, attr.<a name="a49"></a><a class="code" href="../../d4/d00/structem__timer__attr__t.html#adf7a24e643b381f39fec354caf5a4bc0">resparam</a>.<a name="a50"></a><a class="code" href="../../d8/d93/structem__timer__res__param__t.html#a6a48acfe30394982686a96f1f402ac0c">res_ns</a>);</div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;  -max_tmo: %&quot;</span> PRIu64 <span class="stringliteral">&quot; us\n&quot;</span>, attr.<a class="code" href="../../d4/d00/structem__timer__attr__t.html#adf7a24e643b381f39fec354caf5a4bc0">resparam</a>.<a name="a51"></a><a class="code" href="../../d8/d93/structem__timer__res__param__t.html#abb8211175d76213b77c952c1608fbded">max_tmo</a> / 1000);</div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;  -min_tmo: %&quot;</span> PRIu64 <span class="stringliteral">&quot; us\n&quot;</span>, attr.<a class="code" href="../../d4/d00/structem__timer__attr__t.html#adf7a24e643b381f39fec354caf5a4bc0">resparam</a>.<a name="a52"></a><a class="code" href="../../d8/d93/structem__timer__res__param__t.html#a94b92c7b60c5a8cd9ac357b488292fa4">min_tmo</a> / 1000);</div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;  -num_tmo: %d\n&quot;</span>, attr.<a name="a53"></a><a class="code" href="../../d4/d00/structem__timer__attr__t.html#ae6afcdeed8fe620636b1f0391f908afc">num_tmo</a>);</div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;  -clk_src: %d\n&quot;</span>, attr.<a class="code" href="../../d4/d00/structem__timer__attr__t.html#adf7a24e643b381f39fec354caf5a4bc0">resparam</a>.<a name="a54"></a><a class="code" href="../../d8/d93/structem__timer__res__param__t.html#a07ed3b3b2e89e83ca36fb2efbc731c45">clk_src</a>);</div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;  -tick Hz: %&quot;</span> PRIu64 <span class="stringliteral">&quot; hz\n&quot;</span>,</div><div class="line">           <a class="code" href="../../de/dc2/group__em__timer.html#gae97b08e2b1468de76a7d92342a5860ed">em_timer_get_freq</a>(m_shm-&gt;tmr));</div><div class="line"></div><div class="line">    <span class="comment">/* init local EO context */</span></div><div class="line">    eo_ctx-&gt;my_q = m_shm-&gt;eo_q;</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @private</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * EO per thread start function.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> app_eo_start_local(app_eo_ctx_t *eo_ctx, em_eo_t eo)</div><div class="line">{</div><div class="line">    (void)eo_ctx;</div><div class="line">    (void)eo;</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;EO local start\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* per-thread random seed */</span></div><div class="line">    m_randseed = (<span class="keywordtype">unsigned</span> int)<a name="a55"></a><a class="code" href="../../de/dc2/group__em__timer.html#gaabb77ed31727a32d041f9d308a0a3886">em_timer_current_tick</a>(m_shm-&gt;tmr);</div><div class="line"></div><div class="line">    <span class="comment">/* with a low frequency timer we actually get the same seed! */</span></div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @private</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * EO stop function.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> app_eo_stop(app_eo_ctx_t *eo_ctx, em_eo_t eo)</div><div class="line">{</div><div class="line">    em_event_t <span class="keyword">event</span> = <a class="code" href="../../d4/d11/event__machine__types_8h.html#a8542d9c2c9a29e35ff042b1d59cc479b">EM_EVENT_UNDEF</a>;</div><div class="line">    <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> ret;</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;EO stop\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* cancel and delete ongoing timeouts */</span></div><div class="line">    <span class="keywordflow">if</span> (eo_ctx-&gt;periodic_tmo != <a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#af7917fb5bc546e1339ad6e1135fd8c6d">EM_TMO_UNDEF</a>) {</div><div class="line">        <a name="a56"></a><a class="code" href="../../de/dc2/group__em__timer.html#ga02299198fbbddd489006485544892da8">em_tmo_delete</a>(eo_ctx-&gt;periodic_tmo, &amp;event);</div><div class="line">        <span class="keywordflow">if</span> (event != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a8542d9c2c9a29e35ff042b1d59cc479b">EM_EVENT_UNDEF</a>)</div><div class="line">            <a name="a57"></a><a class="code" href="../../d5/d33/group__em__event.html#gad4f97ba217518d967f8078c56023c4d4">em_free</a>(event);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (eo_ctx-&gt;random_tmo != <a class="code" href="../../d7/d1f/event__machine__timer__hw__specific_8h.html#af7917fb5bc546e1339ad6e1135fd8c6d">EM_TMO_UNDEF</a>) {</div><div class="line">        <span class="keyword">event</span> = <a class="code" href="../../d4/d11/event__machine__types_8h.html#a8542d9c2c9a29e35ff042b1d59cc479b">EM_EVENT_UNDEF</a>;</div><div class="line">        <a class="code" href="../../de/dc2/group__em__timer.html#ga02299198fbbddd489006485544892da8">em_tmo_delete</a>(eo_ctx-&gt;random_tmo, &amp;event);</div><div class="line">        <span class="keywordflow">if</span> (event != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a8542d9c2c9a29e35ff042b1d59cc479b">EM_EVENT_UNDEF</a>)</div><div class="line">            <a class="code" href="../../d5/d33/group__em__event.html#gad4f97ba217518d967f8078c56023c4d4">em_free</a>(event);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* remove and delete all of the EO&#39;s queues */</span></div><div class="line">    ret = <a name="a58"></a><a class="code" href="../../d8/d5f/group__em__eo.html#ga10cf8094caa56026eb0a402d3d22da23">em_eo_remove_queue_all_sync</a>(eo, <a name="a59"></a><a class="code" href="../../d4/d11/event__machine__types_8h.html#a419c8373b72a8c5ed1c3e3ded3e262e0">EM_TRUE</a>);</div><div class="line">    test_fatal_if(ret != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>,</div><div class="line">              <span class="stringliteral">&quot;EO remove queue all:%&quot;</span> PRI_STAT <span class="stringliteral">&quot; EO:%&quot;</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#a0bf4a25d46e18ee918e684e5deb27fa4">PRI_EO</a> <span class="stringliteral">&quot;&quot;</span>,</div><div class="line">              ret, eo);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>;</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @private</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * EO receive function. This runs the example app after initialization.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Prints tick-tock at every periodic timeout and in parallel runs random</span></div><div class="line"><span class="comment"> * timeouts that trigger printing of a random quote.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_eo_receive(app_eo_ctx_t *eo_ctx, em_event_t event,</div><div class="line">               <a class="code" href="../../d4/d11/event__machine__types_8h.html#a49fd700da185b0f64834bf967479a992">em_event_type_t</a> type, em_queue_t queue,</div><div class="line">               <span class="keywordtype">void</span> *q_ctx)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> reuse = 0;</div><div class="line">    <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> ret;</div><div class="line"></div><div class="line">    (void)queue;</div><div class="line">    (void)q_ctx;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (unlikely(appl_shm-&gt;exit_flag)) {</div><div class="line">        <a class="code" href="../../d5/d33/group__em__event.html#gad4f97ba217518d967f8078c56023c4d4">em_free</a>(event);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (type == <a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ace0fe27049350469ff1be8188acfea89a2066feedf79f96d10ce9215fa5f37db1">EM_EVENT_TYPE_SW</a>) {</div><div class="line">        app_msg_t *msgin = (app_msg_t *)<a class="code" href="../../d5/d33/group__em__event.html#ga8f701c3a5901fc81d922b9d1d02691e3">em_event_pointer</a>(event);</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span> (msgin-&gt;command) {</div><div class="line">        <span class="keywordflow">case</span> APP_CMD_TMO:</div><div class="line">            <span class="comment">/* print tick-tock */</span></div><div class="line">            msgin-&gt;count++;</div><div class="line">            <span class="keywordflow">if</span> (msgin-&gt;count &amp; 1)</div><div class="line">                APPL_PRINT(<span class="stringliteral">&quot;%&quot;</span> PRIu64 <span class="stringliteral">&quot;. &quot;</span>,</div><div class="line">                       (msgin-&gt;count / 2) + 1);</div><div class="line">            APPL_PRINT((msgin-&gt;count &amp; 1) ? <span class="stringliteral">&quot;tick\n&quot;</span> : <span class="stringliteral">&quot;tock\n&quot;</span>);</div><div class="line"></div><div class="line">            <span class="comment">/* ack periodic timeout, re-use the same event */</span></div><div class="line">            ret = <a name="a60"></a><a class="code" href="../../de/dc2/group__em__timer.html#gaf65f50c383b579720a31154b04ea610e">em_tmo_ack</a>(msgin-&gt;tmo, event);</div><div class="line">            test_fatal_if(ret != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>,</div><div class="line">                      <span class="stringliteral">&quot;em_tmo_ack():%&quot;</span> PRI_STAT, ret);</div><div class="line"></div><div class="line">            reuse = 1; <span class="comment">/* do not free this event */</span></div><div class="line"></div><div class="line">            <span class="comment">/* get random timeouts going after 10th message */</span></div><div class="line">            <span class="keywordflow">if</span> (msgin-&gt;count == 10)</div><div class="line">                new_rand_timeout(eo_ctx);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> APP_CMD_HELLO:</div><div class="line">            APPL_PRINT(<span class="stringliteral">&quot;%s\n\n&quot;</span>, msgin-&gt;text);</div><div class="line">            <span class="comment">/* set next timeout */</span></div><div class="line">            new_rand_timeout(eo_ctx);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            test_error(<a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ac341b7db29d8127e864a45c9bd2a4aa3">EM_ERROR_SET_FATAL</a>(0xDEAD), 0xBEEF,</div><div class="line">                   <span class="stringliteral">&quot;Invalid event!\n&quot;</span>);</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        test_error(<a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ac341b7db29d8127e864a45c9bd2a4aa3">EM_ERROR_SET_FATAL</a>(0xDEAD), 0xBEEF,</div><div class="line">               <span class="stringliteral">&quot;Invalid event type!\n&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* normally free the received event */</span></div><div class="line">    <span class="keywordflow">if</span> (!reuse)</div><div class="line">        <a class="code" href="../../d5/d33/group__em__event.html#gad4f97ba217518d967f8078c56023c4d4">em_free</a>(event);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* sets a new random timeout */</span></div><div class="line"><span class="keywordtype">void</span> new_rand_timeout(app_eo_ctx_t *eo_ctx)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> rnd;</div><div class="line">    app_msg_t *msg;</div><div class="line">    uint64_t period;</div><div class="line">    <a class="code" href="../../d4/d11/event__machine__types_8h.html#adddd88868f7aa0d32b3e40245eb4ef8f">em_status_t</a> stat;</div><div class="line"></div><div class="line">    <span class="comment">/* random timeouts allocate new event every time (could re-use) */</span></div><div class="line">    em_event_t <span class="keyword">event</span> = <a class="code" href="../../d5/d33/group__em__event.html#ga15a17cee0e5de5062e78f7db2b836761">em_alloc</a>(<span class="keyword">sizeof</span>(app_msg_t), <a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ace0fe27049350469ff1be8188acfea89a2066feedf79f96d10ce9215fa5f37db1">EM_EVENT_TYPE_SW</a>,</div><div class="line">                    m_shm-&gt;pool);</div><div class="line">    <span class="keywordflow">if</span> (!event) {</div><div class="line">        test_error(<a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ac341b7db29d8127e864a45c9bd2a4aa3">EM_ERROR_SET_FATAL</a>(0xDEAD), 0xBEEF,</div><div class="line">               <span class="stringliteral">&quot;Can&#39;t allocate event!&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    msg = <a class="code" href="../../d5/d33/group__em__event.html#ga8f701c3a5901fc81d922b9d1d02691e3">em_event_pointer</a>(event);</div><div class="line">    msg-&gt;command = APP_CMD_HELLO;</div><div class="line"></div><div class="line">    <span class="comment">/* new timeout period APP_TIMEOUT_MIN_MS ... APP_TIMEOUT_MODULO */</span></div><div class="line">    <span class="keywordflow">do</span> {</div><div class="line">        rnd = rand_r(&amp;m_randseed);</div><div class="line">        rnd %= APP_TIMEOUT_MODULO_MS;</div><div class="line"></div><div class="line">    } <span class="keywordflow">while</span> (rnd &lt; APP_TIMEOUT_MIN_MS);</div><div class="line"></div><div class="line">    snprintf(msg-&gt;text, APP_MAX_TEXT_LEN, <span class="stringliteral">&quot;%d ms gone!\n&quot;</span>, rnd);</div><div class="line">    msg-&gt;text[APP_MAX_TEXT_LEN - 1] = 0;</div><div class="line"></div><div class="line">    APPL_PRINT(<span class="stringliteral">&quot;Meditation time: what can you do in %d ms?\n&quot;</span>, rnd);</div><div class="line"></div><div class="line">    period = eo_ctx-&gt;hz / 1000;</div><div class="line">    period *= rnd; <span class="comment">/* rnd x ms */</span></div><div class="line"></div><div class="line">    <span class="comment">/* Alternate between set_rel() and set_abs(), roughly half of each */</span></div><div class="line">    <span class="keywordflow">if</span> (rnd &gt; (APP_TIMEOUT_MODULO_MS + APP_TIMEOUT_MIN_MS) / 2)</div><div class="line">        stat = <a class="code" href="../../de/dc2/group__em__timer.html#gabe6b4e51cd71d86d0e60534ba00cbac2">em_tmo_set_rel</a>(eo_ctx-&gt;random_tmo, period, event);</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">        stat = <a name="a61"></a><a class="code" href="../../de/dc2/group__em__timer.html#ga0270ed11757a26046af070264404ecbf">em_tmo_set_abs</a>(eo_ctx-&gt;random_tmo,</div><div class="line">                      <a class="code" href="../../de/dc2/group__em__timer.html#gaabb77ed31727a32d041f9d308a0a3886">em_timer_current_tick</a>(m_shm-&gt;tmr) +</div><div class="line">                      period, event);</div><div class="line">    <span class="keywordflow">if</span> (stat != <a class="code" href="../../d4/d11/event__machine__types_8h.html#a03546e6a7e93665c52d479831e0a6dca">EM_OK</a>)</div><div class="line">        test_error(<a class="code" href="../../d0/d07/event__machine__hw__types_8h.html#ac341b7db29d8127e864a45c9bd2a4aa3">EM_ERROR_SET_FATAL</a>(0xDEAD), 0xBEEF,</div><div class="line">               <span class="stringliteral">&quot;Can&#39;t activate tmo!\n&quot;</span>);</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
  <div id="footer" class="tabs">
   <div class="headertitle"> 
     &copy; 2017 Nokia Networks
   </div>
  </div>
 </body>
</html>
